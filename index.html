<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdgeOne 记账本</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center py-8 px-4">
        
        <!-- Header -->
        <header class="w-full max-w-md bg-white rounded-xl shadow-md p-6 mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">我的记账本</h1>
                <p class="text-sm text-gray-500">简单 • 快捷 • 安全</p>
            </div>
            <button @click="showSettings = true" class="text-gray-400 hover:text-blue-500 transition">
                <i class="fas fa-cog fa-lg"></i>
            </button>
        </header>

        <!-- Summary Cards -->
        <div class="w-full max-w-md grid grid-cols-2 gap-4 mb-6" v-if="isConnected">
            <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500">
                <p class="text-xs text-gray-500 uppercase">本月收入</p>
                <p class="text-xl font-bold text-green-600">+{{ currentMonthIncome.toFixed(2) }}</p>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-red-500">
                <p class="text-xs text-gray-500 uppercase">本月支出</p>
                <p class="text-xl font-bold text-red-600">-{{ currentMonthExpense.toFixed(2) }}</p>
            </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="w-full max-w-md bg-white rounded-xl shadow-md p-6 mb-6" v-if="isConnected">
            <h2 class="text-lg font-semibold mb-4 text-gray-700">记一笔</h2>
            <form @submit.prevent="addTransaction" class="space-y-4">
                <div class="flex space-x-2">
                    <button type="button" 
                        class="flex-1 py-2 rounded-lg text-sm font-medium transition"
                        :class="form.type === 'expense' ? 'bg-red-100 text-red-600 border border-red-200' : 'bg-gray-100 text-gray-500'"
                        @click="form.type = 'expense'">
                        支出
                    </button>
                    <button type="button" 
                        class="flex-1 py-2 rounded-lg text-sm font-medium transition"
                        :class="form.type === 'income' ? 'bg-green-100 text-green-600 border border-green-200' : 'bg-gray-100 text-gray-500'"
                        @click="form.type = 'income'">
                        收入
                    </button>
                </div>

                <div>
                    <input type="number" step="0.01" v-model="form.amount" placeholder="0.00" required
                        class="w-full text-3xl font-bold text-center text-gray-800 border-b-2 border-gray-200 focus:border-blue-500 focus:outline-none py-2 bg-transparent">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">日期</label>
                        <input type="date" v-model="form.date" required
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">分类</label>
                        <select v-model="form.category" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option v-for="cat in currentCategories" :key="cat" :value="cat">{{ cat }}</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">备注 (可选)</label>
                    <input type="text" v-model="form.description" placeholder="例如：早餐、工资..."
                        class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>

                <button type="submit" :disabled="loading"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow transition disabled:opacity-50">
                    <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i> 保存中...</span>
                    <span v-else>保存</span>
                </button>
            </form>
        </div>

        <!-- Recent Transactions -->
        <div class="w-full max-w-md" v-if="isConnected">
            <h2 class="text-lg font-semibold mb-4 text-gray-700 px-1">最近记录</h2>
            
            <div v-if="loadingData" class="text-center py-8 text-gray-500">
                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                <p>加载中...</p>
            </div>

            <div v-else-if="transactions.length === 0" class="text-center py-8 bg-white rounded-xl shadow-sm">
                <p class="text-gray-400">暂无记录，快去记一笔吧！</p>
            </div>

            <div v-else class="space-y-3">
                <div v-for="t in transactions" :key="t.id" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg"
                             :class="t.type === 'income' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'">
                             <i :class="getCategoryIcon(t.category)"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">{{ t.category }}</p>
                            <p class="text-xs text-gray-500">{{ t.date }} <span v-if="t.description">· {{ t.description }}</span></p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold" :class="t.type === 'income' ? 'text-green-600' : 'text-red-600'">
                            {{ t.type === 'income' ? '+' : '-' }}{{ parseFloat(t.amount).toFixed(2) }}
                        </p>
                        <button @click="deleteTransaction(t.id)" class="text-xs text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition">
                            删除
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">设置</h2>
                    <button @click="showSettings = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Supabase URL</label>
                        <input type="text" v-model="config.url" placeholder="https://xyz.supabase.co"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Supabase Anon Key</label>
                        <input type="password" v-model="config.key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <button @click="saveConfig" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg transition">
                        保存连接配置
                    </button>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                    <h3 class="font-bold mb-2"><i class="fas fa-info-circle mr-1"></i> 数据库设置指南</h3>
                    <p class="mb-2">请在 Supabase 的 SQL Editor 中运行以下命令以创建数据表：</p>
                    <div class="bg-gray-800 text-gray-100 p-2 rounded text-xs font-mono overflow-x-auto select-all">
create table transactions (
  id uuid default gen_random_uuid() primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  date date not null,
  type text not null check (type in ('income', 'expense')),
  category text not null,
  amount numeric not null,
  description text
);
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection Warning -->
        <div v-if="!isConnected && !showSettings" class="fixed inset-0 flex items-center justify-center z-40 bg-gray-100">
            <div class="text-center p-8">
                <i class="fas fa-database fa-3x text-gray-300 mb-4"></i>
                <h2 class="text-xl font-bold text-gray-700 mb-2">未连接数据库</h2>
                <p class="text-gray-500 mb-6">请先配置 Supabase 数据库连接信息</p>
                <button @click="showSettings = true" class="bg-blue-600 text-white px-6 py-2 rounded-full font-medium hover:bg-blue-700 transition">
                    去配置
                </button>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const supabase = ref(null);
                const isConnected = ref(false);
                const showSettings = ref(false);
                const loading = ref(false);
                const loadingData = ref(false);
                const transactions = ref([]);

                const config = ref({
                    url: 'https://ieznnydjigcttkpbjnss.supabase.co',
                    key: 'sb_publishable_RcR0ykiJKQXONCNVXBe2HA_eoazDEjL'
                });

                const form = ref({
                    type: 'expense',
                    amount: '',
                    date: new Date().toISOString().split('T')[0],
                    category: '餐饮',
                    description: ''
                });

                const categories = {
                    expense: ['餐饮', '交通', '购物', '娱乐', '居住', '医疗', '教育', '其他'],
                    income: ['工资', '兼职', '理财', '礼金', '其他']
                };

                const currentCategories = computed(() => {
                    return categories[form.value.type];
                });

                // Initialize Supabase
                const initSupabase = () => {
                    if (config.value.url && config.value.key) {
                        try {
                            supabase.value = window.supabase.createClient(config.value.url, config.value.key);
                            isConnected.value = true;
                            fetchTransactions();
                        } catch (e) {
                            console.error("Supabase init error:", e);
                            isConnected.value = false;
                        }
                    } else {
                        isConnected.value = false;
                    }
                };

                const saveConfig = () => {
                    localStorage.setItem('supabase_url', config.value.url);
                    localStorage.setItem('supabase_key', config.value.key);
                    showSettings.value = false;
                    initSupabase();
                };

                const fetchTransactions = async () => {
                    if (!supabase.value) return;
                    loadingData.value = true;
                    try {
                        const { data, error } = await supabase.value
                            .from('transactions')
                            .select('*')
                            .order('date', { ascending: false })
                            .order('created_at', { ascending: false })
                            .limit(50);
                        
                        if (error) throw error;
                        transactions.value = data || [];
                    } catch (e) {
                        alert('获取数据失败: ' + e.message);
                    } finally {
                        loadingData.value = false;
                    }
                };

                const addTransaction = async () => {
                    if (!supabase.value) return;
                    loading.value = true;
                    try {
                        const { error } = await supabase.value
                            .from('transactions')
                            .insert([{
                                type: form.value.type,
                                amount: form.value.amount,
                                date: form.value.date,
                                category: form.value.category,
                                description: form.value.description
                            }]);

                        if (error) throw error;

                        // Reset form partially
                        form.value.amount = '';
                        form.value.description = '';
                        
                        await fetchTransactions();
                    } catch (e) {
                        alert('保存失败: ' + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                const deleteTransaction = async (id) => {
                    if (!confirm('确定要删除这条记录吗？')) return;
                    try {
                        const { error } = await supabase.value
                            .from('transactions')
                            .delete()
                            .eq('id', id);
                        
                        if (error) throw error;
                        await fetchTransactions();
                    } catch (e) {
                        alert('删除失败: ' + e.message);
                    }
                };

                // Statistics
                const currentMonthIncome = computed(() => {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    return transactions.value
                        .filter(t => {
                            const d = new Date(t.date);
                            return t.type === 'income' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                        })
                        .reduce((sum, t) => sum + Number(t.amount), 0);
                });

                const currentMonthExpense = computed(() => {
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    
                    return transactions.value
                        .filter(t => {
                            const d = new Date(t.date);
                            return t.type === 'expense' && d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                        })
                        .reduce((sum, t) => sum + Number(t.amount), 0);
                });

                const getCategoryIcon = (cat) => {
                    const icons = {
                        '餐饮': 'fa-utensils',
                        '交通': 'fa-bus',
                        '购物': 'fa-shopping-bag',
                        '娱乐': 'fa-gamepad',
                        '居住': 'fa-home',
                        '医疗': 'fa-briefcase-medical',
                        '教育': 'fa-graduation-cap',
                        '工资': 'fa-money-bill-wave',
                        '兼职': 'fa-clock',
                        '理财': 'fa-chart-line',
                        '礼金': 'fa-gift',
                        '其他': 'fa-circle'
                    };
                    return `fas ${icons[cat] || 'fa-circle'}`;
                };

                onMounted(() => {
                    initSupabase();
                    if (!isConnected.value) {
                        // showSettings.value = true; // Optionally auto-show settings
                    }
                });

                return {
                    isConnected,
                    showSettings,
                    loading,
                    loadingData,
                    transactions,
                    config,
                    form,
                    currentCategories,
                    currentMonthIncome,
                    currentMonthExpense,
                    saveConfig,
                    addTransaction,
                    deleteTransaction,
                    getCategoryIcon
                };
            }
        }).mount('#app');
    </script>
</body>
</html>